name: CI/CD Azure Deployment

on:
  push:
    branches: ["*"]
  pull_request:

permissions:
  contents: read

jobs:
  # -----------------------------
  # Backend Job
  # -----------------------------
  backend:
    name: Build Backend Docker Image
    runs-on:
      group: RunnerGroup_SBOAIJVDEV
      labels: sboaijvdev-runner-ubuntu-4core-latest
    env:
      IMAGE_NAME: cristal-intelligence-backend
      ACR_NAME: fdeacr
      ACR_SERVER: fdeacr.azurecr.io
      ACR_RG: fde-common
      APP_RG: cristal-rg
      APP_SERVICE_NAME: cristal-backend
      DATABASE_URL: postgresql://cristal_user:Hwe!ryus@cristal-db.postgres.database.azure.com:5432/cristal_db


    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Extract Docker tag
        id: extract_tag
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          else
            TAG_NAME=${GITHUB_REF#refs/heads/}
            TAG_NAME=${TAG_NAME//\//-}  # replace slashes with dash for Docker
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Using Docker tag: $TAG_NAME"

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install Backend Dependencies
        run: |
          python3 -m pip install --upgrade pip
          pip3 install -r backend/requirements.txt

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}
      
      - name: Login to Azure Container Registry
        run: |
          az acr login --name $ACR_NAME

      - name: Build Backend Docker Image
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_REF="${ACR_SERVER%%/}/$IMAGE_NAME:${{ steps.extract_tag.outputs.tag_name }}"
          docker build \
            --platform linux/amd64 \
            -t "$IMAGE_REF" ./backend
      
      - name: Push Docker Image to ACR
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_REF="${ACR_SERVER%%/}/$IMAGE_NAME:${{ steps.extract_tag.outputs.tag_name }}"
          docker push "$IMAGE_REF"
      
      - name: Deploy Backend to Azure App Service
        run: |
          NEW_IMAGE="${ACR_SERVER%%/}/$IMAGE_NAME:${{ steps.extract_tag.outputs.tag_name }}"
          ACR_USER=$(az acr credential show -n $ACR_NAME --query "username" -o tsv)
          ACR_PASS=$(az acr credential show -n $ACR_NAME --query "passwords[0].value" -o tsv)

          az webapp config container set \
            --resource-group "$APP_RG" \
            --name "$APP_SERVICE_NAME" \
            --container-image-name "$NEW_IMAGE" \
            --container-registry-url "https://$ACR_SERVER" \
            --container-registry-user "$ACR_USER" \
            --container-registry-password "$ACR_PASS"

          az webapp restart --resource-group "$APP_RG" --name "$APP_SERVICE_NAME"

  # -----------------------------
  # Frontend Job
  # -----------------------------
  frontend:
    name: Build Frontend Docker Image
    runs-on:
      group: RunnerGroup_SBOAIJVDEV
      labels: sboaijvdev-runner-ubuntu-4core-latest
    env:
      IMAGE_NAME: cristal-intelligence-frontend
      ACR_SERVER: fdeacr.azurecr.io
      ACR_RG: fde-common
      APP_RG: agent-sample-rg
      APP_SERVICE_NAME: agent-sample-frontend
      NEXT_PUBLIC_BACKEND_API_URL: https://agent-sample-backend.azurewebsites.net

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Extract Docker tag
        id: extract_tag
        shell: bash
        run: |
          if [[ "$GITHUB_REF" == refs/tags/* ]]; then
            TAG_NAME=${GITHUB_REF#refs/tags/}
          else
            TAG_NAME=${GITHUB_REF#refs/heads/}
            TAG_NAME=${TAG_NAME//\//-}
          fi
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Using Docker tag: $TAG_NAME"

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 20

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Install Frontend Dependencies
        run: pnpm install
        working-directory: frontend

      - name: Build Chrome Extension
        run: pnpm build
        working-directory: frontend

      # - name: Build Frontend Docker Image
      #   shell: bash
      #   run: |
      #     set -euo pipefail
      #     IMAGE_REF="${ACR_SERVER%%/}/$IMAGE_NAME:${{ steps.extract_tag.outputs.tag_name }}"
      #     docker build \
      #       --platform linux/amd64 \
      #       -t "$IMAGE_REF" ./frontend

      # -----------------------------
      # Azure Deployment (commented out for testing)
      # -----------------------------
      # - name: Azure Login
      #   uses: azure/login@v2
      #   with:
      #     creds: ${{ secrets.AZURE_CREDENTIALS }}
      #
      # - name: Deploy Frontend to Azure App Service
      #   run: |
      #     NEW_IMAGE="${ACR_SERVER%%/}/$IMAGE_NAME:${{ steps.extract_tag.outputs.tag_name }}"
      #     az webapp config container set \
      #       --resource-group "$APP_RG" \
      #       --name "$APP_SERVICE_NAME" \
      #       --container-image-name "$NEW_IMAGE" \
      #       --container-registry-url "https://$ACR_SERVER"
      #     az webapp restart --resource-group "$APP_RG" --name "$APP_SERVICE_NAME"
